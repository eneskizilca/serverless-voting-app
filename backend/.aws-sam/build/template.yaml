AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'Voting App - Polyglot Persistence Architecture (Service 1: DynamoDB
  | Service 2: PostgreSQL)

  '
Globals:
  Function:
    Timeout: 30
    Runtime: python3.9
    Architectures:
    - x86_64
  Api:
    Cors:
      AllowMethods: '''GET,POST,OPTIONS'''
      AllowHeaders: '''Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'''
      AllowOrigin: '''*'''
Resources:
  VotesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: Votes
      AttributeDefinitions:
      - AttributeName: id
        AttributeType: S
      KeySchema:
      - AttributeName: id
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
  VoteSubmissionFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: VoteSubmissionFunction
      Handler: app.lambda_handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: VotesTable
      Events:
        VoteApi:
          Type: Api
          Properties:
            Path: /vote
            Method: post
    Metadata:
      SamResourceId: VoteSubmissionFunction
  CreatePollFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: CreatePollFunction
      Handler: app.lambda_handler
      Events:
        PollApi:
          Type: Api
          Properties:
            Path: /poll
            Method: any
    Metadata:
      SamResourceId: CreatePollFunction
  AnalyticsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AnalyticsFunction
      Handler: app.lambda_handler
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: VotesTable
      Events:
        AnalyticsApi:
          Type: Api
          Properties:
            Path: /results
            Method: get
    Metadata:
      SamResourceId: AnalyticsFunction
Outputs:
  VoteApiUrl:
    Description: API Gateway endpoint URL
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/
  AnalyticsApiUrl:
    Description: API Gateway endpoint URL for Results
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/results
